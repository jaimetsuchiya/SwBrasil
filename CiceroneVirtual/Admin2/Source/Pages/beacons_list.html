include "../Partial/header.html" 


<div id="beacon_modal" class="modal" role="dialog" aria-labelledby="smallModalHead" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form id="frmBeacon" name="frmBeacon">
                <div class="modal-header">
                    Cadastro de Beacons
                    <button type="button" class="close md-close" data-dismiss="modal" aria-hidden="true">&times;</button>
                </div>
                <div class="modal-body">
                    <br />
                
                    <div class="col-sm-6 col-lg-4 col-md-4">
                       <div class="form-group">
                            <label>UID</label>
                            <input type="text" class="form-control" id="txtUID" name="txtUID"/>
                            
                       </div>
                    </div>
                    <div class="col-sm-6 col-lg-4 col-md-4">
                       <div class="form-group">
                            <label>Major</label>
                            <input type="text" class="form-control" id="txtMajor" name="txtMajor"/>
                       </div>
                    </div>
                    <div class="col-sm-6 col-lg-4 col-md-4">
                       <div class="form-group">
                            <label>Minor</label>
                            <input type="text" class="form-control" id="txtMinor" name="txtMinor"/>
                       </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <input type="button" class="btn btn-primary" value="Fechar" data-dismiss="modal" aria-hidden="true" />
                    <input type="submit" class="btn btn-info" value="Salvar"  />
                    <br/><br/>
                    <div class="alert alert-danger" role="alert" id="msgError" style="display:none">
                        <button type="button" class="close" data-dismiss="alert"><span aria-hidden="true">×</span><span class="sr-only">Close</span></button>
                        <strong>Erro!</strong> <span id="modalErrorMsg">Ocorreu um erro no processamento da solicitação!</span>
                    </div>
                    
                    <div class="alert alert-success" role="alert" id="msgOk" style="display:none">
                        <button type="button" class="close" data-dismiss="alert"><span aria-hidden="true">×</span><span class="sr-only">Close</span></button>
                        <strong>Sucesso!</strong> Registro Armazenado com Sucesso! 
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- START BREADCRUMB -->
<ul class="breadcrumb">
    <li><a href="#">Home</a></li>
    <li><a href="#">Beacons</a></li>                    
    <li class="active">Listar</li>
</ul>
<!-- END BREADCRUMB -->                       


<!-- PAGE CONTENT WRAPPER -->
<div class="page-content-wrap">
    
    <!-- START WIDGETS -->
    <div class="row">
        <div class="col-lg-11 col-sm-11 col-md-11">
            <div class="panel panel-default">
    
                <div class="panel-heading">
                    <h3 class="panel-title">Beacons</h3>
                </div>
                <div class="panel-body panel-body-table">
    
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped table-actions">
                            <thead>
                                <tr>
                                    <th width="120">UID</th>
                                    <th width="050">Major</th>
                                    <th width="050">Minor</th>
                                    <th width="100">Bateria</th>
                                    <th width="100">Data</th>
                                    <th width="100">Associado</th>
                                </tr>
                            </thead>
                            <tbody id="list">
                                <!--
                                <tr id="trow_1">
                                    <td class="text-center">1</td>
                                    <td><strong>John Doe</strong></td>
                                    <td><span class="label label-success">New</span></td>
                                    <td>$430.20</td>
                                    <td>24/09/2015</td>
                                    <td>
                                        <button class="btn btn-default btn-rounded btn-condensed btn-sm"><span class="fa fa-pencil"></span></button>
                                        <button class="btn btn-danger btn-rounded btn-condensed btn-sm" onclick="delete_row('trow_1');"><span class="fa fa-times"></span></button>
                                    </td>
                                </tr>
                                <tr id="trow_2">
                                    <td class="text-center">2</td>
                                    <td><strong>Dmitry Ivaniuk</strong></td>
                                    <td><span class="label label-warning">Pending</span></td>
                                    <td>$1,351.00</td>
                                    <td>23/09/2015</td>
                                    <td>
                                        <button class="btn btn-default btn-rounded btn-condensed btn-sm"><span class="fa fa-pencil"></span></button>
                                        <button class="btn btn-danger btn-rounded btn-condensed btn-sm" onclick="delete_row('trow_2');"><span class="fa fa-times"></span></button>
                                    </td>
                                </tr>
                                <tr id="trow_3">
                                    <td class="text-center">3</td>
                                    <td><strong>Nadia Ali</strong></td>
                                    <td><span class="label label-info">In Queue</span></td>
                                    <td>$2,621.00</td>
                                    <td>22/09/2015</td>
                                    <td>
                                        <button class="btn btn-default btn-rounded btn-condensed btn-sm"><span class="fa fa-pencil"></span></button>
                                        <button class="btn btn-danger btn-rounded btn-condensed btn-sm" onclick="delete_row('trow_3');"><span class="fa fa-times"></span></button>
                                    </td>
                                </tr>
                                -->
                            </tbody>
                        </table>
                    </div>                                
    
                </div>
                <div class="panel-footer">
                    <button type="button" class="btn btn-primary" onclick="page.NewBeacon();"><span class="fa fa-plus"></span> Novo Beacon</button>
                    <br/><br/>
                    <div class="alert alert-warning" role="alert" id="msgWarning" style="display:none">
                        <button type="button" class="close" data-dismiss="alert"><span aria-hidden="true">×</span><span class="sr-only">Close</span></button>
                        <strong>Aviso!</strong> Beacon não encontrado!
                    </div>

                </div>
            </div> 
        </div>  
    </div>
    
</div>
<!-- END PAGE CONTENT WRAPPER -->                                

include "../Partial/footer.html"

<script type="text/javascript">
var page = {
    
    Model: null,
    Save: function() {
        
        page.Model.UID = $("#txtUID").val();
        page.Model.Major = $("#txtMajor").val();
        page.Model.Minor = $("#txtMinor").val();
        
        ciceroneVirtual.Beacons.Salvar(page.Model, function(data) {

            $("#txtUID").val("");
            $("#txtMajor").val("");
            $("#txtMinor").val("");
            $("#msgOk").show();
            page.GetBeacons();
            
        }, function(error) {
            var msg = error.errorMsg == null ? "Ocorreu um erro no processamento da solicitação!" : error.errorMsg;
            $("#modalErrorMsg").text( msg );
            $("#msgError").show();
        })
    },
    Edit: function(id){
        
        $("#msgOk").hide();
        $("#msgError").hide();
        
        ciceroneVirtual.Beacons.Carregar(id, function(data) {
            
            page.Model = data;
            $("#txtUID").val( page.Model.UID );
            $("#txtMajor").val( page.Model.Major );
            $("#txtMinor").val( page.Model.Minor );
            
            $('#beacon_modal').on('shown.bs.modal', function (e) {
                $("#txtUID").focus();
            })
            $("#beacon_modal").modal('show');

        }, function(fail) {

            $("#msgWarning").show();

        })
        
    },
    NewBeacon: function() {
        $("#msgOk").hide();
        $("#msgError").hide();
        $('#beacon_modal').on('shown.bs.modal', function (e) {
            $("#txtUID").focus();
        })
        
        page.Model = ciceroneVirtual.Beacons.Novo();
        $("#beacon_modal").modal('show');
    },
    GetBeacons: function() {
        ciceroneVirtual.Beacons.Todos( function(data) {
            
            var html = "";
            var template = "<tr><td width=\"120\"><a href=\"#\" onclick=\"page.Edit('{0}');\">{1}</a></td><td width=\"050\">{2}</td><td width=\"050\">{3}</td><td width=\"100\">{4}</td><td width=\"100\">{5}</td><td width=\"100\">{6}</td></tr>";
            for(var i=0; i < data.length; i++) {
                
                var battery = data[i].Batery == null ? "??" : data[i].Batery;
                var associated = data[i].Associated == null ? "Não" : "Sim";
                
                html += template.replace("{0}", data[i].id)
                                .replace("{1}", data[i].UID)
                                .replace("{2}", data[i].Major)
                                .replace("{3}", data[i].Minor)
                                .replace("{4}", battery)
                                .replace("{5}", data[i]._creation_date.formatarData('dd/mm/yyyy hh:mm'))
                                .replace("{6}", associated)
            }
            $("#list").html(html);
            
        }, function(error) {
            $(".registeredUsers").text("-1");
        })
    }
    
}
    $(document).ready(function() {
        
        page.GetBeacons();
        
        $.validator.setDefaults({
		  submitHandler: function() {
			page.Save();
		  }
	    });
        
        $("#frmBeacon").validate({
			rules: {
				txtUID: {
					required: true,
					minlength: 16
				},
				txtMajor: {
					required: true,
					minlength: 2
				},
				txtMinor: {
					required: true,
					minlength: 2
				},
			},
			messages: {
				txtUID: {
					required: "Favor informar UID",
					minlength: "UID deve conter 16 caracteres"
				},
				txtMajor: {
					required: "Favor informar Major",
					minlength: "UID deve conter 2 caracteres"
				},
				txtMinor: {
					required: "Favor informar Minor",
					minlength: "UID deve conter 2 caracteres"
				},
			}
		});
    })
</script>